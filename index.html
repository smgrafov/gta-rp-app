<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>GTA RP | Ledger Pro v3</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
    <style>
        :root {
            --bg: #0f0f13;
            --card-bg: #1c1c24;
            --accent: #ff9f0a;
            --success: #32d74b;
            --danger: #ff453a;
            --text-main: #ffffff;
            --text-secondary: #8e8e93;
            --grad: linear-gradient(135deg, #ff9f0a 0%, #ff375f 100%);
        }

        body { 
            margin:0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg); color: var(--text-main);
        }

        header { 
            padding: 15px; background: rgba(28, 28, 36, 0.9);
            position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .container { padding: 15px; padding-bottom: 80px; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
        .stat-card {
            background: var(--card-bg); padding: 15px; border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.05); cursor: pointer;
        }

        .stat-card small { color: var(--text-secondary); font-size: 11px; text-transform: uppercase; }
        .stat-card div { font-size: 16px; font-weight: bold; margin-top: 5px; }

        .chart-box { 
            background: var(--card-bg); padding: 15px; border-radius: 16px; 
            margin-bottom: 20px; text-align: center;
        }

        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
        .btn-cat {
            background: var(--card-bg); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px; padding: 15px; color: white; text-align: center; cursor: pointer;
        }

        input {
            width: 100%; background: #000; border: 1px solid #333;
            color: white; padding: 12px; border-radius: 10px; margin-bottom: 10px; box-sizing: border-box;
        }

        .deal-card {
            background: var(--card-bg); margin-bottom: 12px; padding: 15px;
            border-radius: 16px; border-left: 4px solid var(--accent);
        }

        .action-btns { display: flex; gap: 10px; margin-top: 10px; border-top: 1px solid #333; padding-top: 10px; }
        .action-btns button { flex: 1; padding: 8px; border-radius: 6px; border: none; font-size: 12px; cursor: pointer; }

        .hidden { display: none !important; }
        .profit { color: var(--success); }
        .loss { color: var(--danger); }
        
        .primary-btn {
            background: var(--grad); color: white; border: none; padding: 15px;
            border-radius: 12px; width: 100%; font-weight: bold; margin-top: 10px;
        }
    </style>
</head>

<body>

<header>
    <h1 style="margin:0; font-size:18px; color:var(--accent);">GTA LEDGER</h1>
    <button onclick="openDonate()" style="background:#ffd700; border:none; padding:5px 12px; border-radius:20px; font-weight:bold; font-size:12px;">üí∞ –î–û–ù–ê–¢</button>
</header>

<div class="container">
    <div id="mainScreen">
        <div class="stats-grid">
            <div class="stat-card" onclick="showHistory('all')">
                <small>–ó–∞—Ç—Ä–∞—Ç—ã ‚Æï</small>
                <div id="totalBuyDisplay" class="loss">$ 0</div>
            </div>
            <div class="stat-card" onclick="showHistory('all')">
                <small>–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å ‚Æï</small>
                <div id="totalProfitDisplay" class="profit">$ 0</div>
            </div>
        </div>

        <div class="chart-box">
            <small style="color:var(--text-secondary)">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∂</small>
            <canvas id="categoryChart" style="max-height: 200px; margin-top:10px;"></canvas>
        </div>

        <input type="date" id="mainFilterDate" onchange="updateTotals()">

        <div class="menu-grid">
            <div class="btn-cat" onclick="showCategory('–ü—Ä–µ–¥–º–µ—Ç—ã')">üì¶<br>–ü—Ä–µ–¥–º–µ—Ç—ã</div>
            <div class="btn-cat" onclick="showCategory('–ú–∞—à–∏–Ω—ã')">üèéÔ∏è<br>–ú–∞—à–∏–Ω—ã</div>
            <div class="btn-cat" onclick="showCategory('–ê—Ä–µ–Ω–¥–∞')">üîë<br>–ê—Ä–µ–Ω–¥–∞</div>
            <div class="btn-cat" onclick="showCategory('–û–¥–µ–∂–¥–∞')">üëï<br>–û–¥–µ–∂–¥–∞</div>
        </div>
        
        <button onclick="showBonus()" style="width:100%; padding:15px; border-radius:16px; background:var(--card-bg); color:var(--accent); border:1px solid var(--accent); font-weight:bold;">üíé –ë–û–ù–£–°–ö–û–ò–ù–¢–´</button>
    </div>

    <div id="listView" class="hidden">
        <button onclick="backToMain()" style="background:none; border:none; color:var(--accent); font-weight:bold; margin-bottom:15px;">‚Üê –ù–ê–ó–ê–î</button>
        <h2 id="viewTitle" style="margin:0 0 15px 0;">–°–¥–µ–ª–∫–∏</h2>

        <div id="addForm" class="hidden" style="background:var(--card-bg); padding:15px; border-radius:16px; margin-bottom:20px;">
            <input type="text" id="itemName" placeholder="–ß—Ç–æ –∫—É–ø–∏–ª–∏?">
            <div style="display:flex; gap:10px;">
                <input type="number" id="buyPrice" placeholder="–¶–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏">
                <input type="number" id="sellPrice" placeholder="–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏">
            </div>
            <button class="primary-btn" onclick="addDeal()">–°–û–•–†–ê–ù–ò–¢–¨</button>
        </div>

        <div id="itemsContainer"></div>
    </div>

    <div id="bonusView" class="hidden">
        <button onclick="backToMain()" style="background:none; border:none; color:var(--accent); font-weight:bold; margin-bottom:15px;">‚Üê –ù–ê–ó–ê–î</button>
        <h2 style="margin:0 0 15px 0;">–ú–æ–∏ –±–æ–Ω—É—Å—ã</h2>
        <div id="bonusContainer"></div>
        <button class="primary-btn" onclick="addBonusRow()">+ –î–û–ë–ê–í–ò–¢–¨ –ü–ê–†–ê–ú–ï–¢–†</button>
    </div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

const userId = tg.initDataUnsafe.user?.id || "local";
let deals = JSON.parse(localStorage.getItem('deals_'+userId)) || [];
let bonusItems = JSON.parse(localStorage.getItem('bonus_'+userId)) || [{name:'Bonus Coins', val:0}];
let myChart = null;

function format(n) { return '$ ' + Math.abs(n).toLocaleString(); }

function save() {
    localStorage.setItem('deals_'+userId, JSON.stringify(deals));
    localStorage.setItem('bonus_'+userId, JSON.stringify(bonusItems));
}

// –ü–µ—Ä–µ—Ö–æ–¥—ã
function showCategory(cat) {
    activeCategory = cat;
    document.getElementById('mainScreen').classList.add('hidden');
    document.getElementById('listView').classList.remove('hidden');
    document.getElementById('addForm').classList.remove('hidden');
    document.getElementById('viewTitle').textContent = cat;
    renderList('category');
}

function showHistory() {
    document.getElementById('mainScreen').classList.add('hidden');
    document.getElementById('listView').classList.remove('hidden');
    document.getElementById('addForm').classList.add('hidden');
    document.getElementById('viewTitle').textContent = '–ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö —Å–¥–µ–ª–æ–∫';
    renderList('all');
}

function showBonus() {
    document.getElementById('mainScreen').classList.add('hidden');
    document.getElementById('bonusView').classList.remove('hidden');
    renderBonus();
}

function backToMain() {
    document.getElementById('listView').classList.add('hidden');
    document.getElementById('bonusView').classList.add('hidden');
    document.getElementById('mainScreen').classList.remove('hidden');
    updateTotals();
}

// –°–¥–µ–ª–∫–∏
function addDeal() {
    const name = document.getElementById('itemName').value;
    const b = Number(document.getElementById('buyPrice').value) || 0;
    const s = Number(document.getElementById('sellPrice').value) || 0;
    if(!name) return;

    deals.push({id: Date.now(), cat: activeCategory, name, b, s, d: new Date().toISOString().split('T')[0]});
    save();
    document.getElementById('itemName').value = '';
    document.getElementById('buyPrice').value = '';
    document.getElementById('sellPrice').value = '';
    renderList('category');
}

function renderList(mode) {
    const cont = document.getElementById('itemsContainer');
    cont.innerHTML = '';
    const filtered = mode === 'all' ? deals : deals.filter(x => x.cat === activeCategory);
    
    filtered.sort((a,b) => b.id - a.id).forEach(x => {
        const p = x.s - x.b;
        const div = document.createElement('div');
        div.className = 'deal-card';
        div.innerHTML = `
            <div id="v-${x.id}">
                <small style="color:var(--text-secondary)">${x.d} ‚Ä¢ ${x.cat}</small><br>
                <div style="display:flex; justify-content:space-between; margin-top:5px;">
                    <b>${x.name}</b>
                    <b class="${p>=0?'profit':'loss'}">${p>=0?'+':''}${format(p)}</b>
                </div>
                <div class="action-btns">
                    <button onclick="deleteDeal(${x.id})" style="background:rgba(255,69,58,0.1); color:var(--danger)">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            </div>
        `;
        cont.appendChild(div);
    });
}

function deleteDeal(id) {
    deals = deals.filter(x => x.id !== id);
    save();
    renderList(document.getElementById('addForm').classList.contains('hidden') ? 'all' : 'category');
}

// –ë–æ–Ω—É—Å—ã
function renderBonus() {
    const cont = document.getElementById('bonusContainer');
    cont.innerHTML = '';
    bonusItems.forEach((x, i) => {
        const d = document.createElement('div');
        d.style.marginBottom = '10px';
        d.innerHTML = `
            <input type="text" value="${x.name}" onchange="editBonus(${i},'name',this.value)" style="margin-bottom:5px;">
            <input type="number" value="${x.val}" onchange="editBonus(${i},'val',this.value)">
            <button onclick="delBonus(${i})" style="color:var(--danger); background:none; border:none; width:100%; font-size:11px;">–£–¥–∞–ª–∏—Ç—å</button>
        `;
        cont.appendChild(d);
    });
}

function addBonusRow() { bonusItems.push({name:'', val:0}); renderBonus(); }
function editBonus(i, f, v) { bonusItems[i][f] = f==='val'?Number(v):v; save(); }
function delBonus(i) { bonusItems.splice(i,1); save(); renderBonus(); }

// –ì–ª–∞–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∏ –≥—Ä–∞—Ñ–∏–∫–∏
function updateTotals() {
    const date = document.getElementById('mainFilterDate').value;
    const filtered = date ? deals.filter(x => x.d === date) : deals;
    
    const buy = filtered.reduce((a, b) => a + b.b, 0);
    const profit = filtered.reduce((a, b) => a + (b.s - b.b), 0);
    
    document.getElementById('totalBuyDisplay').textContent = format(buy);
    document.getElementById('totalProfitDisplay').textContent = (profit>=0?'+':'') + format(profit);
    
    updateChart(filtered);
}

function updateChart(data) {
    const ctx = document.getElementById('categoryChart').getContext('2d');
    const cats = ['–ü—Ä–µ–¥–º–µ—Ç—ã', '–ú–∞—à–∏–Ω—ã', '–ê—Ä–µ–Ω–¥–∞', '–û–¥–µ–∂–¥–∞'];
    const values = cats.map(c => data.filter(x => x.cat === c).length);

    if(myChart) myChart.destroy();
    
    myChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: cats,
            datasets: [{
                data: values,
                backgroundColor: ['#ff9f0a', '#32d74b', '#ff453a', '#5856d6'],
                borderWidth: 0,
                hoverOffset: 4
            }]
        },
        options: {
            plugins: { 
                legend: { position: 'bottom', labels: { color: '#8e8e93', font: { size: 10 } } }
            },
            cutout: '70%'
        }
    });
}

function openDonate() { tg.openLink('https://donationalerts.com'); }

// –°—Ç–∞—Ä—Ç
document.getElementById('mainFilterDate').value = new Date().toISOString().split('T')[0];
updateTotals();
</script>

</body>
</html>
