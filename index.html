<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>GTA RP | Ultimate Ledger</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
    <style>
        :root {
            --bg: #0b0b0e;
            --card-bg: #16161d;
            --accent: #ff9f0a;
            --success: #30d158;
            --danger: #ff453a;
            --text-main: #ffffff;
            --text-secondary: #8e8e93;
        }

        body { 
            margin:0; font-family: -apple-system, system-ui, sans-serif;
            background: var(--bg); color: var(--text-main); 
        }

        header { padding: 15px; background: var(--card-bg); display: flex; justify-content: space-between; align-items: center; }
        .container { padding: 15px; padding-bottom: 50px; }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .stat-card { background: var(--card-bg); padding: 15px; border-radius: 14px; border-bottom: 3px solid transparent; }
        .stat-card.red { border-bottom-color: var(--danger); }
        .stat-card.green { border-bottom-color: var(--success); }
        .stat-card div { font-size: 18px; font-weight: 800; margin-top: 4px; }

        /* –ì—Ä–∞—Ñ–∏–∫ */
        .chart-container { background: var(--card-bg); border-radius: 16px; padding: 15px; margin-top: 20px; }

        /* –ú–µ–Ω—é */
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .cat-card { background: var(--card-bg); border-radius: 16px; padding: 15px; text-align: center; cursor: pointer; }
        .journal-btn { background: #24242f; color: #fff; padding: 12px; border-radius: 12px; text-align: center; margin: 15px 0; cursor: pointer; }

        /* –ë–æ–Ω—É—Å—ã –∏ –ö–≤–µ—Å—Ç—ã */
        .quest-item {
            background: var(--card-bg); padding: 12px; border-radius: 12px;
            margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between;
        }
        .quest-item.done { opacity: 0.5; border-left: 3px solid var(--success); }
        
        .checkbox-custom {
            width: 24px; height: 24px; border-radius: 6px; border: 2px solid var(--accent);
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .done .checkbox-custom { background: var(--accent); color: #000; }

        input { width: 100%; background: #000; border: 1px solid #2c2c2e; color: #fff; padding: 12px; border-radius: 10px; margin-bottom: 8px; box-sizing: border-box; }
        .primary-btn { background: linear-gradient(135deg, #ff9f0a 0%, #ff375f 100%); color: #fff; border: none; padding: 15px; border-radius: 12px; width: 100%; font-weight: 700; }
        
        .hidden { display: none !important; }
        .profit { color: var(--success); }
        .loss { color: var(--danger); }
    </style>
</head>

<body>

<header>
    <div style="font-weight: 900;">LEDGER <span style="color:var(--accent)">PRO</span></div>
    <button onclick="tg.openLink('https://donationalerts.com')" style="background:var(--accent); border:none; padding:6px 14px; border-radius:8px; font-weight:bold; font-size:11px;">–î–û–ù–ê–¢</button>
</header>

<div class="container">
    <div id="mainScreen">
        <div class="stats-grid">
            <div class="stat-card red"><small>–†–ê–°–•–û–î</small><div id="totalBuy" class="loss">$ 0</div></div>
            <div class="stat-card green"><small>–ü–†–ò–ë–´–õ–¨</small><div id="totalProfit" class="profit">$ 0</div></div>
        </div>

        <div class="journal-btn" onclick="showHistory()">üìÇ –ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö —Å–¥–µ–ª–æ–∫</div>
        <input type="date" id="dateFilter" onchange="updateUI()">

        <div class="menu-grid">
            <div class="cat-card" onclick="openCategory('–ü—Ä–µ–¥–º–µ—Ç—ã')">üì¶<br>–ü—Ä–µ–¥–º–µ—Ç—ã</div>
            <div class="cat-card" onclick="openCategory('–ú–∞—à–∏–Ω—ã')">üèéÔ∏è<br>–ú–∞—à–∏–Ω—ã</div>
            <div class="cat-card" onclick="openCategory('–ê—Ä–µ–Ω–¥–∞')">üîë<br>–ê—Ä–µ–Ω–¥–∞</div>
            <div class="cat-card" onclick="openCategory('–û–¥–µ–∂–¥–∞')">üëï<br>–û–¥–µ–∂–¥–∞</div>
        </div>

        <button onclick="openBonus()" style="width:100%; margin-top:10px; padding:15px; border-radius:16px; background:var(--card-bg); color:var(--accent); border: 1px solid var(--accent); font-weight:bold;">üíé –ë–û–ù–£–°–´ –ò –ó–ê–î–ê–ù–ò–Ø</button>

        <div class="chart-container">
            <small style="color:var(--text-secondary)">–ê–ù–ê–õ–ò–ó–ê –ü–†–ò–ë–´–õ–ò</small>
            <canvas id="lineChart" style="margin-top:10px;"></canvas>
        </div>
    </div>

    <div id="viewList" class="hidden">
        <button onclick="goBack()" style="background:none; border:none; color:var(--accent); margin-bottom:15px;">‚Üê –ù–ê–ó–ê–î</button>
        <h2 id="viewTitle">–°–¥–µ–ª–∫–∏</h2>
        <div id="formAdd" class="hidden" style="background:var(--card-bg); padding:15px; border-radius:16px; margin-bottom:15px;">
            <input type="text" id="inName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
            <div style="display:flex; gap:8px;">
                <input type="number" id="inBuy" placeholder="–ö—É–ø–∏–ª">
                <input type="number" id="inSell" placeholder="–ü—Ä–æ–¥–∞–ª">
            </div>
            <button class="primary-btn" onclick="saveDeal()">–î–û–ë–ê–í–ò–¢–¨</button>
        </div>
        <div id="itemsList"></div>
    </div>

    <div id="viewBonus" class="hidden">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <button onclick="goBack()" style="background:none; border:none; color:var(--accent); font-weight:bold;">‚Üê –ù–ê–ó–ê–î</button>
            <button onclick="resetQuests()" style="background:var(--danger); border:none; color:white; padding:5px 10px; border-radius:8px; font-size:10px;">–°–ë–†–û–°–ò–¢–¨ –ü–†–û–ì–†–ï–°–°</button>
        </div>
        <h2 style="margin:15px 0;">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∫–≤–µ—Å—Ç—ã</h2>
        <div id="questList"></div>
    </div>
</div>

<script>
const tg = window.Telegram.WebApp;
const storageKey = 'gta_ledger_v4_' + (tg.initDataUnsafe.user?.id || 'dev');

let state = JSON.parse(localStorage.getItem(storageKey)) || {
    deals: [],
    quests: [
        "3 —á–∞—Å–∞ –æ–Ω–ª–∞–π–Ω", "–õ–æ—Ç–µ—Ä–µ—è", "–¢–∏—Ä", "–ö–∏–Ω–æ—Å—Ç—É–¥–∏—è", "–ö–∏–Ω–æ—Ç–µ–∞—Ç—Ä", "–°–∞–π—Ç", "Brawl", "–õ–∞–π–∫ –≤ Match", 
        "–û—Ç–∫—Ä—ã—Ç—å –∫–µ–π—Å", "–ö–∏–Ω—É—Ç—å –º—è—á–∏–∫", "–î—Ä–µ—Å—Å–∏—Ä–æ–≤–∫–∞", "–°—Ç–∞–≤–∫–∞ –≤ –∫–æ–ª–µ—Å–µ", "–ú–µ—Ç—Ä–æ", "–†—ã–±–∞–ª–∫–∞", 
        "–ó–∞–¥–∞–Ω–∏—è –∫–ª—É–±–∞", "–ê–≤—Ç–æ—Å–µ—Ä–≤–∏—Å", "–ë–∞—Å–∫–µ—Ç–±–æ–ª", "–§—É—Ç–±–æ–ª", "–ê—Ä–º—Ä–µ—Å—Ç–ª–∏–Ω–≥", "–î–∞—Ä—Ç—Å", "–í–æ–ª–µ–π–±–æ–ª", 
        "–ü–∏–Ω–≥-–ø–æ–Ω–≥", "–ë–æ–ª—å—à–æ–π —Ç–µ–Ω–Ω–∏—Å", "–°—ã–≥—Ä–∞—Ç—å –≤ –º–∞—Ñ–∏—é", "–ü–ª–∞—Ç–µ–∂ –ø–æ –ª–∏–∑–∏–Ω–≥—É", "–ì–æ–Ω–∫–∞", "–ê—Ä–µ–Ω–∞", 
        "–°—Ç—Ä–æ–π–∫–∞", "–ü–æ—Ä—Ç", "–®–∞—Ö—Ç–∞", "–§–µ—Ä–º–∞", "–ö–∞—Ä—Ç–∏–Ω–≥", "–°–æ–∫—Ä–æ–≤–∏—â–µ", "–ê–≤—Ç–æ–±—É—Å", "–ü–æ—á—Ç–∞", "–ù—É–ª–∏ –≤ –∫–∞–∑–∏–Ω–æ", 
        "–î–µ–Ω—Å –±–∞—Ç–ª", "–¢—Ä–µ–Ω–∞–∂–µ—Ä–Ω—ã–π –∑–∞–ª", "–¢—Ä–µ–Ω–µ—Ä. –∫–æ–º–ø–ª–µ–∫—Å", "–û—Ö–æ—Ç–∞", "–ü–æ–∂–∞—Ä–Ω—ã–π", "–î–∞–ª—å–Ω–æ–±–æ–π—â–∏–∫", 
        "–ó–∞–∫–∞–∑ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤", "–°–º–µ–Ω–∞ –≤–Ω–µ—à–Ω–æ—Å—Ç–∏", "–ì—Ä–∞—Ñ—Ñ–∏—Ç–∏", "–ö–æ–Ω—Ç—Ä–∞–±–∞–Ω–¥–∞", "–¢—Ä–∞–≤–∞ –≤ —Ç–µ–ø–ª–∏—Ü–µ", 
        "–û–±–µ–∑–±–æ–ª –≤ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏", "–ë–∏–∑–≤–∞—Ä", "–ö–∞–ø—Ç", "–•–∞–º–º–µ—Ä —Å –í–ó–•", "–ú–µ–¥–∫–∞—Ä—Ç—ã –≤ EMS", "–í—ã–∑–æ–≤—ã –≤ EMS", 
        "–ó–µ–ª—ë–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ WN", "–û–±—ä—è–≤–ª–µ–Ω–∏—è WN", "–û–≥—Ä–∞–±–ª–µ–Ω–∏—è –¥–æ–º–æ–≤", "–ö–æ–¥—ã", "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∞–≤—Ç–æ", 
        "–ê—Ä–µ—Å—Ç", "–í—ã–∫—É–ø —Å –ö–ü–ó", "–ê–∏—Ä–¥—Ä–æ–ø"
    ].map(q => ({name: q, done: false}))
};

let chart = null;

function save() { localStorage.setItem(storageKey, JSON.stringify(state)); updateUI(); }
function fmt(v) { return '$ ' + Math.abs(v).toLocaleString(); }

// –ù–∞–≤–∏–≥–∞—Ü–∏—è
function openCategory(c) { activeCat = c; toggleView('viewList'); document.getElementById('formAdd').classList.remove('hidden'); renderDeals('cat'); }
function showHistory() { activeCat = ''; toggleView('viewList'); document.getElementById('formAdd').classList.add('hidden'); renderDeals('all'); }
function openBonus() { toggleView('viewBonus'); renderQuests(); }
function goBack() { toggleView('mainScreen'); }
function toggleView(id) { 
    document.querySelectorAll('.container > div').forEach(d => d.classList.add('hidden')); 
    document.getElementById(id).classList.remove('hidden'); 
}

// –°–¥–µ–ª–∫–∏
function saveDeal() {
    const n = document.getElementById('inName').value, b = Number(document.getElementById('inBuy').value)||0, s = Number(document.getElementById('inSell').value)||0;
    if(!n) return;
    state.deals.push({id: Date.now(), cat: activeCat, name: n, buy: b, sell: s, date: new Date().toISOString().split('T')[0]});
    document.getElementById('inName').value = ''; document.getElementById('inBuy').value = ''; document.getElementById('inSell').value = '';
    save(); renderDeals('cat');
}

function renderDeals(mode) {
    const cont = document.getElementById('itemsList'); cont.innerHTML = '';
    const list = mode === 'all' ? state.deals : state.deals.filter(d => d.cat === activeCat);
    list.sort((a,b) => b.id - a.id).forEach(d => {
        const p = d.sell - d.buy;
        cont.innerHTML += `<div class="quest-item"><div><small>${d.cat}</small><br><b>${d.name}</b></div><div style="text-align:right"><div class="${p>=0?'profit':'loss'}">${fmt(p)}</div><small onclick="deleteDeal(${d.id})" style="color:var(--danger)">–£–¥–∞–ª–∏—Ç—å</small></div></div>`;
    });
}
function deleteDeal(id) { state.deals = state.deals.filter(d => d.id !== id); save(); renderDeals(activeCat?'cat':'all'); }

// –ö–≤–µ—Å—Ç—ã
function renderQuests() {
    const cont = document.getElementById('questList'); cont.innerHTML = '';
    state.quests.forEach((q, i) => {
        const div = document.createElement('div');
        div.className = 'quest-item ' + (q.done ? 'done' : '');
        div.innerHTML = `<span>${q.name}</span><div class="checkbox-custom" onclick="toggleQuest(${i})">${q.done ? '‚úì' : ''}</div>`;
        cont.appendChild(div);
    });
}
function toggleQuest(i) { state.quests[i].done = !state.quests[i].done; save(); renderQuests(); }
function resetQuests() { if(confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è?')) { state.quests.forEach(q => q.done = false); save(); renderQuests(); } }

// UI –∏ –ì—Ä–∞—Ñ–∏–∫
function updateUI() {
    const filter = document.getElementById('dateFilter').value;
    const filtered = filter ? state.deals.filter(d => d.date === filter) : state.deals;
    const buy = filtered.reduce((a, b) => a + b.buy, 0), prof = filtered.reduce((a, b) => a + (b.sell - b.buy), 0);
    document.getElementById('totalBuy').textContent = fmt(buy);
    document.getElementById('totalProfit').textContent = (prof>=0?'+':'') + fmt(prof);
    renderChart();
}

function renderChart() {
    const ctx = document.getElementById('lineChart').getContext('2d');
    const cats = ['–ü—Ä–µ–¥–º–µ—Ç—ã', '–ú–∞—à–∏–Ω—ã', '–ê—Ä–µ–Ω–¥–∞', '–û–¥–µ–∂–¥–∞'];
    const data = cats.map(c => state.deals.filter(d => d.cat === c).reduce((a, b) => a + (b.sell - b.buy), 0));
    
    if(chart) chart.destroy();
    chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: cats,
            datasets: [{ label: '–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å', data: data, backgroundColor: ['#ff9f0a', '#30d158', '#ff453a', '#5856d6'], borderRadius: 8 }]
        },
        options: { plugins: { legend: { display: false } }, scales: { y: { grid: { color: '#222' }, ticks: { color: '#888' } }, x: { ticks: { color: '#888' } } } }
    });
}

document.getElementById('dateFilter').value = new Date().toISOString().split('T')[0];
updateUI();
</script>
</body>
</html>
