<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>GTA RP Ledger | Elite</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
    <style>
        :root {
            --bg: #0b0b0e;
            --card-bg: #16161d;
            --accent: #ff9f0a;
            --success: #30d158;
            --danger: #ff453a;
            --text-main: #ffffff;
            --text-secondary: #8e8e93;
            --grad: linear-gradient(135deg, #ff9f0a 0%, #ff375f 100%);
        }

        body { 
            margin:0; font-family: -apple-system, system-ui, sans-serif;
            background: var(--bg); color: var(--text-main); line-height: 1.4;
        }

        header { 
            padding: 15px; background: var(--card-bg);
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .container { padding: 15px; padding-bottom: 40px; }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .stat-card {
            background: var(--card-bg); padding: 15px; border-radius: 14px;
            border-bottom: 3px solid transparent;
        }
        .stat-card.red { border-bottom-color: var(--danger); }
        .stat-card.green { border-bottom-color: var(--success); }
        .stat-card small { color: var(--text-secondary); font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-card div { font-size: 18px; font-weight: 800; margin-top: 4px; }

        /* –ö–Ω–æ–ø–∫–∞ –∂—É—Ä–Ω–∞–ª–∞ */
        .journal-btn {
            background: #24242f; color: #fff; padding: 12px; border-radius: 12px;
            text-align: center; margin-bottom: 20px; font-size: 14px; font-weight: 600;
            cursor: pointer; border: 1px solid rgba(255,255,255,0.05);
        }

        /* –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ */
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .cat-card {
            background: var(--card-bg); border-radius: 16px; padding: 20px;
            text-align: center; border: 1px solid rgba(255,255,255,0.03);
            transition: 0.2s;
        }
        .cat-card:active { transform: scale(0.96); background: #1c1c26; }
        .cat-icon { font-size: 28px; margin-bottom: 8px; display: block; }

        /* –ë–æ–Ω—É—Å—ã –≤ —Å—Ç–∏–ª–µ Assistant */
        .bonus-item {
            background: var(--card-bg); border-radius: 14px; padding: 15px;
            margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between;
        }
        .bonus-info { display: flex; align-items: center; gap: 12px; }
        .bonus-circle { 
            width: 40px; height: 40px; border-radius: 50%; 
            background: rgba(255,159,10,0.1); color: var(--accent);
            display: flex; align-items: center; justify-content: center; font-weight: bold;
        }

        /* –ò–Ω–ø—É—Ç—ã */
        input {
            width: 100%; background: #000; border: 1px solid #2c2c2e;
            color: #fff; padding: 12px; border-radius: 10px; margin-bottom: 8px; box-sizing: border-box;
        }

        .primary-btn {
            background: var(--grad); color: #fff; border: none; padding: 15px;
            border-radius: 12px; width: 100%; font-weight: 700; cursor: pointer;
        }

        .deal-card {
            background: var(--card-bg); padding: 12px; border-radius: 12px;
            margin-bottom: 8px; border-left: 3px solid var(--accent);
        }

        .hidden { display: none !important; }
        .profit { color: var(--success); }
        .loss { color: var(--danger); }
    </style>
</head>

<body>

<header>
    <div style="font-weight: 900; letter-spacing: -0.5px;">LEDGER <span style="color:var(--accent)">PRO</span></div>
    <button onclick="tg.openLink('https://donationalerts.com')" style="background:var(--accent); border:none; padding:6px 14px; border-radius:8px; font-weight:bold; font-size:11px;">–î–û–ù–ê–¢</button>
</header>

<div class="container">
    <div id="mainScreen">
        <div class="stats-grid">
            <div class="stat-card red">
                <small>–û–±—â–∏–π —Ä–∞—Å—Ö–æ–¥</small>
                <div id="displayTotalBuy" class="loss">$ 0</div>
            </div>
            <div class="stat-card green">
                <small>–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å</small>
                <div id="displayTotalProfit" class="profit">$ 0</div>
            </div>
        </div>

        <div class="journal-btn" onclick="showHistory()">üìÇ –û—Ç–∫—Ä—ã—Ç—å –æ–±—â–∏–π –∂—É—Ä–Ω–∞–ª —Å–¥–µ–ª–æ–∫</div>

        <div style="margin-bottom: 15px;">
            <label style="font-size: 11px; color: var(--text-secondary); margin-left: 5px;">–§–ò–õ–¨–¢–† –ü–û –î–ê–¢–ï</label>
            <input type="date" id="dateFilter" onchange="updateUI()">
        </div>

        <div class="menu-grid">
            <div class="cat-card" onclick="openCategory('–ü—Ä–µ–¥–º–µ—Ç—ã')"><span class="cat-icon">üì¶</span>–ü—Ä–µ–¥–º–µ—Ç—ã</div>
            <div class="cat-card" onclick="openCategory('–ú–∞—à–∏–Ω—ã')"><span class="cat-icon">üèéÔ∏è</span>–ú–∞—à–∏–Ω—ã</div>
            <div class="cat-card" onclick="openCategory('–ê—Ä–µ–Ω–¥–∞')"><span class="cat-icon">üîë</span>–ê—Ä–µ–Ω–¥–∞</div>
            <div class="cat-card" onclick="openCategory('–û–¥–µ–∂–¥–∞')"><span class="cat-icon">üëï</span>–û–¥–µ–∂–¥–∞</div>
        </div>

        <div class="cat-card" onclick="openBonus()" style="margin-top:10px; width:100%; box-sizing:border-box; border: 1px dashed var(--accent);">
            <span style="color:var(--accent); font-weight:bold;">üíé –ë–û–ù–£–°–ö–û–ò–ù–¢–´</span>
        </div>
    </div>

    <div id="viewList" class="hidden">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:20px;">
            <button onclick="goBack()" style="background:none; border:none; color:var(--accent); font-size:20px;">‚Üê</button>
            <h2 id="viewTitle" style="margin:0; font-size:20px;">–°–¥–µ–ª–∫–∏</h2>
        </div>

        <div id="formAdd" class="hidden" style="background:var(--card-bg); padding:15px; border-radius:16px; margin-bottom:20px;">
            <input type="text" id="inName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞">
            <div style="display:flex; gap:8px;">
                <input type="number" id="inBuy" placeholder="–¶–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏">
                <input type="number" id="inSell" placeholder="–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏">
            </div>
            <button class="primary-btn" onclick="saveDeal()">–î–û–ë–ê–í–ò–¢–¨ –ó–ê–ü–ò–°–¨</button>
        </div>

        <div id="itemsList"></div>
    </div>

    <div id="viewBonus" class="hidden">
        <button onclick="goBack()" style="background:none; border:none; color:var(--accent); margin-bottom:15px; font-weight:bold;">‚Üê –ù–ê–ó–ê–î</button>
        <h2 style="margin:0 0 20px 0;">–£—á–µ—Ç –ë–æ–Ω—É—Å–æ–≤</h2>
        
        <div id="bonusList"></div>
        
        <div style="background:var(--card-bg); padding:15px; border-radius:16px; margin-top:20px;">
            <input type="text" id="bnName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä. BC)">
            <input type="number" id="bnVal" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ">
            <button class="primary-btn" onclick="addBonus()">+ –î–û–ë–ê–í–ò–¢–¨ –ü–ê–†–ê–ú–ï–¢–†</button>
        </div>
    </div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const storageKey = 'gta_ledger_' + (tg.initDataUnsafe.user?.id || 'dev');
let data = JSON.parse(localStorage.getItem(storageKey)) || { deals: [], bonuses: [] };
let activeCat = '';

function fmt(v) { return '$ ' + Math.abs(v).toLocaleString(); }

function save() { 
    localStorage.setItem(storageKey, JSON.stringify(data)); 
    updateUI();
}

// –ù–∞–≤–∏–≥–∞—Ü–∏—è
function openCategory(cat) {
    activeCat = cat;
    document.getElementById('mainScreen').classList.add('hidden');
    document.getElementById('viewList').classList.remove('hidden');
    document.getElementById('formAdd').classList.remove('hidden');
    document.getElementById('viewTitle').textContent = cat;
    renderDeals('cat');
}

function showHistory() {
    activeCat = '';
    document.getElementById('mainScreen').classList.add('hidden');
    document.getElementById('viewList').classList.remove('hidden');
    document.getElementById('formAdd').classList.add('hidden');
    document.getElementById('viewTitle').textContent = '–ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö —Å–¥–µ–ª–æ–∫';
    renderDeals('all');
}

function openBonus() {
    document.getElementById('mainScreen').classList.add('hidden');
    document.getElementById('viewBonus').classList.remove('hidden');
    renderBonuses();
}

function goBack() {
    document.querySelectorAll('.container > div').forEach(d => d.classList.add('hidden'));
    document.getElementById('mainScreen').classList.remove('hidden');
}

// –õ–æ–≥–∏–∫–∞ —Å–¥–µ–ª–æ–∫
function saveDeal() {
    const name = document.getElementById('inName').value;
    const b = Number(document.getElementById('inBuy').value) || 0;
    const s = Number(document.getElementById('inSell').value) || 0;
    if(!name) return;

    data.deals.push({
        id: Date.now(),
        cat: activeCat,
        name: name,
        buy: b,
        sell: s,
        date: new Date().toISOString().split('T')[0]
    });
    
    document.getElementById('inName').value = '';
    document.getElementById('inBuy').value = '';
    document.getElementById('inSell').value = '';
    save();
    renderDeals('cat');
}

function renderDeals(mode) {
    const cont = document.getElementById('itemsList');
    cont.innerHTML = '';
    const list = mode === 'all' ? data.deals : data.deals.filter(d => d.cat === activeCat);
    
    list.sort((a,b) => b.id - a.id).forEach(d => {
        const prof = d.sell - d.buy;
        cont.innerHTML += `
            <div class="deal-card">
                <div style="display:flex; justify-content:space-between; align-items:start;">
                    <div>
                        <small style="color:var(--text-secondary)">${d.date} ‚Ä¢ ${d.cat}</small><br>
                        <b>${d.name}</b>
                    </div>
                    <div style="text-align:right">
                        <div class="${prof>=0?'profit':'loss'}">${prof>=0?'+':''}${fmt(prof)}</div>
                        <small style="color:var(--danger)" onclick="deleteDeal(${d.id})">–£–¥–∞–ª–∏—Ç—å</small>
                    </div>
                </div>
                <div style="font-size:11px; margin-top:5px; color:var(--text-secondary)">
                    –ó–∞–∫—É–ø: ${fmt(d.buy)} | –ü—Ä–æ–¥–∞–∂–∞: ${fmt(d.sell)}
                </div>
            </div>
        `;
    });
}

function deleteDeal(id) {
    data.deals = data.deals.filter(d => d.id !== id);
    save();
    renderDeals(activeCat ? 'cat' : 'all');
}

// –õ–æ–≥–∏–∫–∞ –±–æ–Ω—É—Å–æ–≤
function addBonus() {
    const name = document.getElementById('bnName').value;
    const val = Number(document.getElementById('bnVal').value) || 0;
    if(!name) return;
    data.bonuses.push({name, val});
    save();
    renderBonuses();
    document.getElementById('bnName').value = '';
    document.getElementById('bnVal').value = '';
}

function renderBonuses() {
    const cont = document.getElementById('bonusList');
    cont.innerHTML = '';
    data.bonuses.forEach((b, i) => {
        cont.innerHTML += `
            <div class="bonus-item">
                <div class="bonus-info">
                    <div class="bonus-circle">${b.name[0].toUpperCase()}</div>
                    <div>
                        <div style="font-weight:bold;">${b.name}</div>
                        <div style="font-size:12px; color:var(--text-secondary)">–ù–∞–∫–æ–ø–ª–µ–Ω–æ</div>
                    </div>
                </div>
                <div style="text-align:right">
                    <div style="color:var(--accent); font-weight:800;">${b.val.toLocaleString()}</div>
                    <small style="color:var(--danger)" onclick="data.bonuses.splice(${i},1); save(); renderBonuses();">‚úï</small>
                </div>
            </div>
        `;
    });
}

// –ì–ª–∞–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
function updateUI() {
    const filter = document.getElementById('dateFilter').value;
    const filtered = filter ? data.deals.filter(d => d.date === filter) : data.deals;
    
    // –ü–†–ê–í–ò–õ–¨–ù–´–ô –†–ê–°–ß–ï–¢:
    // –†–∞—Å—Ö–æ–¥ = –°—É–º–º–∞ –≤—Å–µ—Ö –ø–æ–∫—É–ø–æ–∫
    // –ü—Ä–∏–±—ã–ª—å = –°—É–º–º–∞ (–ü—Ä–æ–¥–∞–∂–∞ - –ü–æ–∫—É–ø–∫–∞)
    const totalExp = filtered.reduce((acc, d) => acc + d.buy, 0);
    const totalProf = filtered.reduce((acc, d) => acc + (d.sell - d.buy), 0);
    
    document.getElementById('displayTotalBuy').textContent = fmt(totalExp);
    document.getElementById('displayTotalProfit').textContent = (totalProf>=0?'+':'') + fmt(totalProf);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.getElementById('dateFilter').value = new Date().toISOString().split('T')[0];
updateUI();
</script>

</body>
</html>
