<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>GTA RP | Ledger Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
    <style>
        :root {
            --bg: #0f0f13;
            --card-bg: #1c1c24;
            --accent: #ff9f0a;
            --success: #32d74b;
            --danger: #ff453a;
            --text-main: #ffffff;
            --text-secondary: #8e8e93;
            --grad: linear-gradient(135deg, #ff9f0a 0%, #ff375f 100%);
        }

        body { 
            margin:0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg); 
            color: var(--text-main);
            overflow-x: hidden;
        }

        header { 
            padding: 20px 15px;
            background: rgba(28, 28, 36, 0.8);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 { margin: 0; font-size: 18px; font-weight: 800; color: var(--accent); }

        .container { padding: 15px; padding-bottom: 50px; }

        .stats-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
            margin-bottom: 20px; 
        }

        .stat-card {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.05);
            cursor: pointer;
            transition: transform 0.1s;
        }
        .stat-card:active { transform: scale(0.97); }

        .stat-card small { color: var(--text-secondary); font-size: 11px; text-transform: uppercase; }
        .stat-card div { font-size: 18px; font-weight: bold; margin-top: 5px; }

        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        .btn-cat {
            background: var(--card-bg);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 20px;
            color: white;
            text-align: center;
            cursor: pointer;
        }

        /* –ü–æ–ª—è –≤–≤–æ–¥–∞ */
        .edit-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 10px;
            margin-top: 10px;
        }

        input {
            width: 100%;
            background: #000;
            border: 1px solid #333;
            color: white;
            padding: 10px;
            border-radius: 8px;
            box-sizing: border-box;
        }

        .primary-btn {
            background: var(--grad);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 12px;
            width: 100%;
            font-weight: bold;
            margin-top: 10px;
        }

        /* –°–ø–∏—Å–æ–∫ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
        .deal-card {
            background: var(--card-bg);
            margin-bottom: 12px;
            padding: 15px;
            border-radius: 16px;
            border-left: 4px solid var(--accent);
        }

        .deal-header { display: flex; justify-content: space-between; align-items: flex-start; }
        
        .deal-meta { font-size: 12px; color: var(--text-secondary); margin-bottom: 5px; }

        .price-info { display: flex; gap: 15px; margin: 10px 0; font-size: 14px; }
        
        .action-btns { display: flex; gap: 10px; margin-top: 10px; border-top: 1px solid #333; padding-top: 10px; }
        .action-btns button { 
            flex: 1; 
            padding: 8px; 
            border-radius: 6px; 
            border: none; 
            font-size: 12px; 
            font-weight: bold;
            cursor: pointer;
        }

        .hidden { display: none; }
        .profit { color: var(--success); }
        .loss { color: var(--danger); }
    </style>
</head>

<body>

<header>
    <h1>GTA LEDGER</h1>
    <div style="font-size: 12px; color: var(--text-secondary);" id="currentDateDisplay"></div>
</header>

<div class="container">

    <div id="mainScreen">
        <div class="stats-grid">
            <div class="stat-card" onclick="showHistory('all')">
                <small>–í—Å–µ –∑–∞—Ç—Ä–∞—Ç—ã ‚Æï</small>
                <div id="totalBuy" class="loss">$0</div>
            </div>
            <div class="stat-card" onclick="showHistory('all')">
                <small>–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å ‚Æï</small>
                <div id="totalProfit" class="profit">$0</div>
            </div>
        </div>

        <input type="date" id="mainFilterDate" onchange="updateTotals()" style="margin-bottom: 20px;">

        <div class="menu-grid">
            <div class="btn-cat" onclick="showCategory('–ü—Ä–µ–¥–º–µ—Ç—ã')">üì¶<br>–ü—Ä–µ–¥–º–µ—Ç—ã</div>
            <div class="btn-cat" onclick="showCategory('–ú–∞—à–∏–Ω—ã')">üèéÔ∏è<br>–ú–∞—à–∏–Ω—ã</div>
            <div class="btn-cat" onclick="showCategory('–ê—Ä–µ–Ω–¥–∞')">üîë<br>–ê—Ä–µ–Ω–¥–∞</div>
            <div class="btn-cat" onclick="showCategory('–û–¥–µ–∂–¥–∞')">üëï<br>–û–¥–µ–∂–¥–∞</div>
        </div>
        
        <button onclick="showBonus()" style="width:100%; margin-top:12px; padding:15px; border-radius:16px; background:var(--card-bg); color:var(--accent); border:1px solid var(--accent);">üíé –ú–æ–∏ –ë–æ–Ω—É—Å–ö–æ–∏–Ω—Ç—ã</button>
    </div>

    <div id="listView" class="hidden">
        <div style="display:flex; justify-content: space-between; align-items: center;">
            <button onclick="backToMain()" style="background:none; border:none; color:var(--accent); font-weight:bold; padding:10px 0;">‚Üê –ù–ê–ó–ê–î</button>
            <h3 id="viewTitle" style="margin:0; font-size:16px;">–°–¥–µ–ª–∫–∏</h3>
        </div>

        <div id="addForm" class="hidden" style="background:var(--card-bg); padding:15px; border-radius:16px; margin: 15px 0;">
            <input type="text" id="itemName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
            <div style="display:flex; gap:10px; margin-top:10px;">
                <input type="number" id="buyPrice" placeholder="–ü–æ–∫—É–ø–∫–∞">
                <input type="number" id="sellPrice" placeholder="–ü—Ä–æ–¥–∞–∂–∞">
            </div>
            <button class="primary-btn" onclick="addDeal()">+ –î–û–ë–ê–í–ò–¢–¨</button>
        </div>

        <div id="itemsContainer" style="margin-top:20px;">
            </div>
    </div>

</div>

<script>
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

const userId = tg.initDataUnsafe.user?.id || "dev_user";
let deals = JSON.parse(localStorage.getItem('deals_'+userId)) || [];
let currentMode = ''; // 'category' –∏–ª–∏ 'all'
let activeCategory = '';

function formatMoney(num) {
    return '$ ' + Math.abs(num).toLocaleString('ru-RU');
}

// –ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≤—Å–µ—Ö —Å–¥–µ–ª–æ–∫ (–ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Å—Ç–∞—Ç-–∫–∞—Ä—Ç–æ—á–∫–∏)
function showHistory(mode) {
    currentMode = 'all';
    activeCategory = '';
    document.getElementById('mainScreen').classList.add('hidden');
    document.getElementById('listView').classList.remove('hidden');
    document.getElementById('addForm').classList.add('hidden');
    document.getElementById('viewTitle').textContent = '–ñ—É—Ä–Ω–∞–ª –≤—Å–µ—Ö —Å–¥–µ–ª–æ–∫';
    renderList();
}

// –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
function showCategory(cat) {
    currentMode = 'category';
    activeCategory = cat;
    document.getElementById('mainScreen').classList.add('hidden');
    document.getElementById('listView').classList.remove('hidden');
    document.getElementById('addForm').classList.remove('hidden');
    document.getElementById('viewTitle').textContent = cat;
    renderList();
}

function backToMain() {
    document.getElementById('listView').classList.add('hidden');
    document.getElementById('mainScreen').classList.remove('hidden');
    updateTotals();
}

function addDeal() {
    const name = document.getElementById('itemName').value;
    const buy = Number(document.getElementById('buyPrice').value) || 0;
    const sell = Number(document.getElementById('sellPrice').value) || 0;
    
    if(!name) return;

    const newDeal = {
        id: Date.now(),
        category: activeCategory,
        name: name,
        buy: buy,
        sell: sell,
        date: new Date().toISOString().split('T')[0]
    };

    deals.push(newDeal);
    save();
    document.getElementById('itemName').value = '';
    document.getElementById('buyPrice').value = '';
    document.getElementById('sellPrice').value = '';
    renderList();
}

function renderList() {
    const container = document.getElementById('itemsContainer');
    container.innerHTML = '';

    let displayDeals = currentMode === 'all' 
        ? deals 
        : deals.filter(d => d.category === activeCategory);

    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: —Å–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ
    displayDeals.sort((a,b) => b.id - a.id);

    displayDeals.forEach(d => {
        const profit = d.sell - d.buy;
        const card = document.createElement('div');
        card.className = 'deal-card';
        card.innerHTML = `
            <div id="view-${d.id}">
                <div class="deal-meta">${d.date} ‚Ä¢ ${d.category}</div>
                <div class="deal-header">
                    <strong style="font-size:16px;">${d.name}</strong>
                    <span class="${profit >= 0 ? 'profit' : 'loss'}" style="font-weight:bold;">
                        ${profit >= 0 ? '‚Üë' : '‚Üì'} ${formatMoney(profit)}
                    </span>
                </div>
                <div class="price-info">
                    <span>–ü–æ–∫—É–ø–∫–∞: <span style="color:#888;">${formatMoney(d.buy)}</span></span>
                    <span>–ü—Ä–æ–¥–∞–∂–∞: <span style="color:#888;">${formatMoney(d.sell)}</span></span>
                </div>
                <div class="action-btns">
                    <button onclick="editMode(${d.id})" style="background:#333; color:white;">‚öôÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button onclick="deleteDeal(${d.id})" style="background:rgba(255,69,58,0.2); color:var(--danger);">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                </div>
            </div>
            <div id="edit-${d.id}" class="hidden">
                <div class="edit-row">
                    <input type="text" id="edit-name-${d.id}" value="${d.name}">
                    <input type="number" id="edit-buy-${d.id}" value="${d.buy}">
                    <input type="number" id="edit-sell-${d.id}" value="${d.sell}">
                    <div style="display:flex; gap:10px;">
                        <button onclick="saveEdit(${d.id})" style="flex:2; background:var(--success); color:black; padding:10px; border-radius:8px; border:none; font-weight:bold;">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <button onclick="renderList()" style="flex:1; background:#444; color:white; padding:10px; border-radius:8px; border:none;">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(card);
    });
}

function editMode(id) {
    document.getElementById(`view-${id}`).classList.add('hidden');
    document.getElementById(`edit-${id}`).classList.remove('hidden');
}

function saveEdit(id) {
    const index = deals.findIndex(d => d.id === id);
    if(index !== -1) {
        deals[index].name = document.getElementById(`edit-name-${id}`).value;
        deals[index].buy = Number(document.getElementById(`edit-buy-${id}`).value);
        deals[index].sell = Number(document.getElementById(`edit-sell-${id}`).value);
        save();
        renderList();
    }
}

function deleteDeal(id) {
    if(confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å–¥–µ–ª–∫—É?')) {
        deals = deals.filter(d => d.id !== id);
        save();
        renderList();
    }
}

function updateTotals() {
    const filterDate = document.getElementById('mainFilterDate').value;
    const filtered = filterDate ? deals.filter(d => d.date === filterDate) : deals;
    
    const totalBuy = filtered.reduce((a, b) => a + b.buy, 0);
    const totalProfit = filtered.reduce((a, b) => a + (b.sell - b.buy), 0);
    
    document.getElementById('totalBuy').textContent = formatMoney(totalBuy);
    document.getElementById('totalProfit').textContent = (totalProfit >= 0 ? '+' : '') + formatMoney(totalProfit);
}

function save() {
    localStorage.setItem('deals_'+userId, JSON.stringify(deals));
}

// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã –≤ —Ñ–∏–ª—å—Ç—Ä –∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫
const today = new Date().toISOString().split('T')[0];
document.getElementById('mainFilterDate').value = today;
document.getElementById('currentDateDisplay').textContent = today;

updateTotals();
</script>

</body>
</html>
